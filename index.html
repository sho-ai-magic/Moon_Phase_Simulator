<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœˆã¨å¤ªé™½ã®ä½ç½®é–¢ä¿‚ãƒ»æº€ã¡æ¬ ã‘ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼</title>
    <!-- Tailwind CSS for UI styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Three.js and OrbitControls -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; color: #fff; font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; }
        #canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; }
        
        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #4F46E5;
            cursor: pointer;
            margin-top: -8px;
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #4B5563;
            border-radius: 3px;
        }
        
        /* æ—¥ä»˜å…¥åŠ›ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’ç™½ãã™ã‚‹(Chromeå‘ã‘) */
        ::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }
    </style>
</head>
<body class="antialiased">

    <!-- ä¿¯ç°ç”¨ãƒ¡ã‚¤ãƒ³ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
    <div id="canvas-container"></div>

    <!-- UI ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« -->
    <div class="absolute top-0 left-0 p-3 sm:p-5 z-10 pointer-events-none w-full sm:w-[420px] max-h-screen overflow-y-auto overflow-x-hidden">
        <div class="bg-gray-900/85 backdrop-blur-md p-4 sm:p-5 rounded-2xl border border-gray-700 shadow-[0_10px_40px_rgba(0,0,0,0.8)] pointer-events-auto">
            <h1 class="text-lg sm:text-xl font-bold mb-4 text-center tracking-wider flex items-center justify-center gap-2">
                <span>ğŸŒ</span> åœ°çƒãƒ»æœˆãƒ»å¤ªé™½ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼
            </h1>
            
            <div class="flex flex-col gap-3">
                <!-- ğŸŒŸ æ—¥ä»˜ãƒ»ã‚¤ãƒ™ãƒ³ãƒˆã‹ã‚‰è¨­å®š -->
                <div class="bg-indigo-900/40 p-3 rounded-xl border border-indigo-500/50 flex flex-col gap-3">
                    
                    <!-- æ—¥ä»˜æŒ‡å®š -->
                    <div>
                        <label class="font-semibold text-green-300 text-sm block mb-1">ğŸ“… å®Ÿéš›ã®æ—¥ä»˜ã‹ã‚‰ä½ç½®ã‚’è¨ˆç®—</label>
                        <div class="flex gap-2">
                            <input type="date" id="date-input" class="flex-1 bg-gray-900 text-white border border-gray-600 rounded-lg p-2 text-sm focus:outline-none focus:border-indigo-500">
                            <button id="date-btn" class="bg-indigo-600 hover:bg-indigo-500 text-white px-3 py-1 rounded-lg text-sm transition-colors whitespace-nowrap shadow-lg">é©ç”¨</button>
                        </div>
                    </div>

                    <div class="w-full h-px bg-indigo-500/30"></div>

                    <!-- ã‚¤ãƒ™ãƒ³ãƒˆãƒ—ãƒªã‚»ãƒƒãƒˆ -->
                    <div>
                        <label class="font-semibold text-green-300 text-sm block mb-1">ğŸŒŸ ç‰¹æ®Šãªè¦³æ¸¬ã‚¤ãƒ™ãƒ³ãƒˆã‚’å†ç¾</label>
                        <select id="preset-select" class="w-full bg-gray-900 text-white border border-gray-600 rounded-lg p-2 text-sm focus:outline-none focus:border-indigo-500 cursor-pointer transition-colors">
                            <option value="none">è‡ªç”±ã«æ“ä½œã™ã‚‹</option>
                            <option value="total-solar">ğŸŒ‘ çš†æ—¢æ—¥é£Ÿ (æ–°æœˆãƒ»å‚¾ã0Â°)</option>
                            <option value="partial-solar">ğŸŒ’ éƒ¨åˆ†æ—¥é£Ÿ (æ–°æœˆãƒ»ã‚ãšã‹ã«å‚¾ã)</option>
                            <option value="total-lunar">ğŸ”´ çš†æ—¢æœˆé£Ÿ (æº€æœˆãƒ»å‚¾ã0Â°)</option>
                            <option value="partial-lunar">ğŸŒ– éƒ¨åˆ†æœˆé£Ÿ (æº€æœˆãƒ»ã‚ãšã‹ã«å‚¾ã)</option>
                        </select>
                    </div>

                    <p class="text-[10px] text-gray-400 leading-tight">â€»æ—¥ä»˜è¨ˆç®—ã¯ç°¡æ˜“çš„ãªè»Œé“è¨ˆç®—ã«åŸºã¥ãæ¦‚ç®—ã§ã™ã€‚å³å¯†ãªä½ç½®ã‚„æ—¥é£Ÿãƒ»æœˆé£Ÿã®ç™ºç”Ÿã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                </div>

                <!-- æœˆã®æ“ä½œ -->
                <div class="bg-gray-800/60 p-3 rounded-xl border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <label class="font-semibold text-indigo-300 text-sm">æœˆã®ä½ç½® (å…¬è»¢)</label>
                        <span id="moon-angle-display" class="text-xs bg-gray-900 px-2 py-1 rounded">90Â°</span>
                    </div>
                    <input type="range" id="moon-slider" min="0" max="360" value="90" step="1">
                    
                    <div class="mt-3 flex items-center justify-between">
                        <span class="text-xs text-gray-400">è‡ªå‹•å†ç”Ÿ:</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="auto-play" class="sr-only peer">
                            <div class="w-9 h-5 bg-gray-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-500"></div>
                        </label>
                    </div>
                </div>

                <!-- è»Œé“ã®å‚¾ã (ç™½é“å‚¾æ–œè§’) -->
                <div class="bg-gray-800/60 p-3 rounded-xl border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <label class="font-semibold text-pink-300 text-sm">æœˆã®è»Œé“ã®å‚¾ã</label>
                        <span id="inclination-display" class="text-xs bg-gray-900 px-2 py-1 rounded">5.0Â°</span>
                    </div>
                    <input type="range" id="inclination-slider" min="0" max="15" value="5" step="0.5">
                    <p class="text-[10px] text-gray-400 mt-2 leading-tight">å®Ÿéš›ã¯ç´„5åº¦å‚¾ã„ã¦ã„ã‚‹ãŸã‚æ¯æœˆã€Œé£Ÿã€ã¯èµ·ãã¾ã›ã‚“ã€‚0Â°ã«è¿‘ã¥ãã¨é£ŸãŒèµ·ã“ã‚Šã‚„ã™ããªã‚Šã¾ã™ã€‚</p>
                </div>

                <!-- å¤ªé™½ã®æ“ä½œ -->
                <div class="bg-gray-800/60 p-3 rounded-xl border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <label class="font-semibold text-yellow-400 text-sm">å¤ªé™½ã®ä½ç½®</label>
                        <span id="sun-angle-display" class="text-xs bg-gray-900 px-2 py-1 rounded">0Â°</span>
                    </div>
                    <input type="range" id="sun-slider" min="0" max="360" value="0" step="1">
                </div>
            </div>
        </div>
    </div>

    <!-- åœ°çƒã‹ã‚‰ã®è¦–ç‚¹ï¼ˆæœˆã®æº€ã¡æ¬ ã‘PiPè¡¨ç¤ºï¼‰ -->
    <div class="absolute bottom-6 right-6 z-10 flex flex-col items-center pointer-events-none">
        <div class="relative w-40 h-40 sm:w-56 sm:h-56 bg-black border-4 border-gray-700 rounded-full shadow-[0_0_30px_rgba(0,0,0,0.8)] overflow-hidden pointer-events-auto">
            <!-- æº€ã¡æ¬ ã‘ã®åå‰è¡¨ç¤º -->
            <div id="phase-name" class="absolute top-4 left-0 w-full text-center z-20 text-sm sm:text-base font-bold text-yellow-300 drop-shadow-lg tracking-widest">
                ä¸Šå¼¦ã®æœˆ
            </div>
            
            <!-- åœ°çƒè¦–ç‚¹ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
            <canvas id="pip-canvas" class="absolute top-0 left-0 w-full h-full z-10"></canvas>
            
            <!-- ä¸‹éƒ¨ã®ãƒ©ãƒ™ãƒ« -->
            <div class="absolute bottom-4 left-0 w-full text-center z-20 text-xs sm:text-sm text-gray-300 drop-shadow-md">
                ğŸ‘€ åœ°çƒã‹ã‚‰è¦‹ãŸæœˆ
            </div>
        </div>
        
        <!-- æ“ä½œãƒ’ãƒ³ãƒˆ -->
        <div class="mt-4 text-xs text-gray-400 bg-black/50 px-3 py-1 rounded-full backdrop-blur">
            èƒŒæ™¯ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦è¦–ç‚¹ã‚’å›è»¢ã§ãã¾ã™
        </div>
    </div>

    <script>
        window.onload = function() {
            // --- UIè¦ç´ ã®å–å¾— ---
            const moonSlider = document.getElementById('moon-slider');
            const sunSlider = document.getElementById('sun-slider');
            const inclinationSlider = document.getElementById('inclination-slider');
            const presetSelect = document.getElementById('preset-select');
            const dateInput = document.getElementById('date-input');
            const dateBtn = document.getElementById('date-btn');
            const moonDisplay = document.getElementById('moon-angle-display');
            const sunDisplay = document.getElementById('sun-angle-display');
            const inclinationDisplay = document.getElementById('inclination-display');
            const autoPlayCheck = document.getElementById('auto-play');
            const phaseNameDisplay = document.getElementById('phase-name');

            // --- æ—¥ä»˜ã®åˆæœŸåŒ–ï¼ˆä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆï¼‰ ---
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            dateInput.value = `${year}-${month}-${day}`;

            // --- Three.js åŸºæœ¬è¨­å®š ---
            const scene = new THREE.Scene();
            
            // å®‡å®™ã®èƒŒæ™¯ï¼ˆæ˜Ÿï¼‰ã‚’ä½œæˆ
            const createStars = () => {
                const starsGeometry = new THREE.BufferGeometry();
                const starsMaterial = new THREE.PointsMaterial({color: 0xffffff, size: 0.1, transparent: true, opacity: 0.8});
                const starsVertices = [];
                for(let i=0; i<2000; i++) {
                    const x = (Math.random() - 0.5) * 200;
                    const y = (Math.random() - 0.5) * 200;
                    const z = (Math.random() - 0.5) * 200;
                    starsVertices.push(x, y, z);
                }
                starsGeometry.setAttribute('position', new THREE.Float32BufferAttribute(starsVertices, 3));
                const starField = new THREE.Points(starsGeometry, starsMaterial);
                scene.add(starField);
            };
            createStars();

            // --- ã‚«ãƒ¡ãƒ©è¨­å®š ---
            // 1. ä¿¯ç°ç”¨ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¡ãƒ© (UIã¨è¢«ã‚‰ãªã„ã‚ˆã†ã«å³å´ã«å¯„ã›ã€å°‘ã—å¼•ã)
            const mainCamera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
            mainCamera.position.set(15, 40, 60);

            // 2. åœ°çƒã‹ã‚‰æœˆã‚’è¦‹ã‚‹ã‚«ãƒ¡ãƒ© (PiPç”¨)
            // è¦–é‡è§’ã‚’ç‹­ãã—ã¦æœˆã‚’ã‚ºãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã™ã‚‹
            const earthCamera = new THREE.PerspectiveCamera(8, 1, 0.1, 100);
            earthCamera.position.set(0, 0, 0); // åœ°çƒã®ä¸­å¿ƒã«é…ç½®

            // --- ãƒ¬ã‚¤ãƒ¤ãƒ¼è¨­å®šï¼ˆåœ°çƒã®å†…éƒ¨ã‹ã‚‰æœˆã‚’è¦‹ã‚‹ãŸã‚ã€åœ°çƒã‚’éš ã™ä»•çµ„ã¿ï¼‰ ---
            // ãƒ¬ã‚¤ãƒ¤ãƒ¼0: é€šå¸¸ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼ˆæœˆã€å¤ªé™½ã€æ˜Ÿï¼‰
            // ãƒ¬ã‚¤ãƒ¤ãƒ¼1: åœ°çƒã®ã¿
            mainCamera.layers.enable(1); // ãƒ¡ã‚¤ãƒ³ã‚«ãƒ¡ãƒ©ã¯ä¸¡æ–¹è¦‹ãˆã‚‹
            earthCamera.layers.disable(1); // åœ°çƒã‚«ãƒ¡ãƒ©ã¯åœ°çƒï¼ˆãƒ¬ã‚¤ãƒ¤ãƒ¼1ï¼‰ã‚’è¦‹ãªã„

            // --- ãƒ¬ãƒ³ãƒ€ãƒ©ãƒ¼è¨­å®š ---
            const container = document.getElementById('canvas-container');
            const mainRenderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            mainRenderer.setSize(window.innerWidth, window.innerHeight);
            mainRenderer.setPixelRatio(window.devicePixelRatio);
            mainRenderer.shadowMap.enabled = true;
            mainRenderer.shadowMap.type = THREE.PCFSoftShadowMap;
            container.appendChild(mainRenderer.domElement);

            const pipCanvas = document.getElementById('pip-canvas');
            const pipRenderer = new THREE.WebGLRenderer({ canvas: pipCanvas, antialias: true, alpha: true });
            // PiPã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºï¼ˆCSSã«åˆã‚ã›ã‚‹ï¼‰
            const pipSize = pipCanvas.parentElement.clientWidth;
            pipRenderer.setSize(pipSize, pipSize);
            pipRenderer.setPixelRatio(window.devicePixelRatio);
            pipRenderer.shadowMap.enabled = true;
            pipRenderer.shadowMap.type = THREE.PCFSoftShadowMap;

            // ã‚«ãƒ¡ãƒ©ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆãƒ¡ã‚¤ãƒ³ã‚«ãƒ¡ãƒ©ã®ã¿ï¼‰
            const controls = new THREE.OrbitControls(mainCamera, mainRenderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.minDistance = 10;
            controls.maxDistance = 100;
            // åœ°çƒã¨å¤ªé™½ã®é–“ãã‚‰ã„ã‚’æ³¨è¦–ç‚¹ã«ã™ã‚‹ã“ã¨ã§ã€å…¨ä½“ãŒå³ã«å¯„ã‚ŠUIè¢«ã‚Šã‚’é˜²ã
            controls.target.set(10, 0, 0);

            // --- ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ ---
            // 1. åœ°çƒ
            const earthGeometry = new THREE.SphereGeometry(2, 32, 32);
            const earthMaterial = new THREE.MeshPhongMaterial({ 
                color: 0x1E88E5, // é’ã„åœ°çƒ
                emissive: 0x001133,
                specular: 0x111111,
                shininess: 10 
            });
            const earth = new THREE.Mesh(earthGeometry, earthMaterial);
            earth.castShadow = true;
            earth.receiveShadow = true;
            earth.layers.set(1); // åœ°çƒã‚«ãƒ¡ãƒ©ã‹ã‚‰éš ã™ãŸã‚ã«ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã«è¨­å®š
            scene.add(earth);

            // 2. æœˆ
            const moonGeometry = new THREE.SphereGeometry(0.6, 32, 32);
            const moonMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xdddddd, 
                roughness: 0.8,
                metalness: 0.1
            });
            const moon = new THREE.Mesh(moonGeometry, moonMaterial);
            moon.castShadow = true;
            moon.receiveShadow = true;
            scene.add(moon);

            // 3. å¤ªé™½ï¼ˆè¦–è¦šçš„ãªçƒä½“ï¼‰è¦–ç›´å¾„ã‚’æœˆã«åˆã‚ã›ã‚‹ãŸã‚ã«å°ã•ãã™ã‚‹
            const sunGeometry = new THREE.SphereGeometry(1.75, 32, 32);
            const sunMaterial = new THREE.MeshBasicMaterial({ color: 0xFFD54F }); // ç™ºå…‰è‰²
            const sun = new THREE.Mesh(sunGeometry, sunMaterial);
            scene.add(sun);

            // å¤ªé™½ã®å…‰ã®è¡¨ç¾ï¼ˆãƒãƒ­ãƒ¼ï¼‰
            const sunGlowGeometry = new THREE.SphereGeometry(2.2, 32, 32);
            const sunGlowMaterial = new THREE.MeshBasicMaterial({ color: 0xFFCA28, transparent: true, opacity: 0.3 });
            const sunGlow = new THREE.Mesh(sunGlowGeometry, sunGlowMaterial);
            sun.add(sunGlow);

            // è»Œé“ã®ç·šã‚’æç”»
            let moonOrbitGroup = new THREE.Group();
            scene.add(moonOrbitGroup);

            let moonOrbitLine;
            const drawMoonOrbit = () => {
                const curve = new THREE.EllipseCurve(0, 0, 12, 12, 0, 2 * Math.PI, false, 0);
                const points = curve.getPoints(100);
                const geometry = new THREE.BufferGeometry().setFromPoints(points);
                const material = new THREE.LineBasicMaterial({ color: 0x888888, transparent: true, opacity: 0.3 });
                moonOrbitLine = new THREE.Line(geometry, material);
                moonOrbitLine.rotation.x = Math.PI / 2; // XZå¹³é¢ã«å¯ã‹ã›ã‚‹
                moonOrbitGroup.add(moonOrbitLine);
            };
            drawMoonOrbit();

            const drawSunOrbit = () => {
                const curve = new THREE.EllipseCurve(0, 0, 35, 35, 0, 2 * Math.PI, false, 0);
                const points = curve.getPoints(100);
                const geometry = new THREE.BufferGeometry().setFromPoints(points);
                const material = new THREE.LineBasicMaterial({ color: 0xFFD54F, transparent: true, opacity: 0.3 });
                const ellipse = new THREE.Line(geometry, material);
                ellipse.rotation.x = Math.PI / 2; // XZå¹³é¢ã«å¯ã‹ã›ã‚‹
                scene.add(ellipse);
            };
            drawSunOrbit();

            // --- ç…§æ˜è¨­å®š ---
            // å¤ªé™½å…‰ï¼ˆæŒ‡å‘æ€§ãƒ©ã‚¤ãƒˆï¼‰
            const sunLight = new THREE.DirectionalLight(0xffffff, 2.0);
            sunLight.castShadow = true;
            sunLight.shadow.mapSize.width = 1024;
            sunLight.shadow.mapSize.height = 1024;
            sunLight.shadow.camera.left = -15;
            sunLight.shadow.camera.right = 15;
            sunLight.shadow.camera.top = 15;
            sunLight.shadow.camera.bottom = -15;
            sunLight.shadow.camera.near = 0.5;
            sunLight.shadow.camera.far = 100;
            sunLight.shadow.bias = -0.002;
            scene.add(sunLight);

            // å®‡å®™ç©ºé–“ã®ã‚ãšã‹ãªç’°å¢ƒå…‰ï¼ˆå½±ã‚’æš—ãã™ã‚‹ãŸã‚ã«å¼±ã‚ã‚‹ï¼‰
            const ambientLight = new THREE.AmbientLight(0x333344, 0.05);
            scene.add(ambientLight);

            // --- å¤‰æ•° ---
            const moonDistance = 12;
            const sunDistance = 35;
            let moonAngleDeg = parseFloat(moonSlider.value);
            let sunAngleDeg = parseFloat(sunSlider.value);
            let inclinationDeg = parseFloat(inclinationSlider.value);

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ‰‹å‹•ã§ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚’å‹•ã‹ã—ãŸã¨ãã«ãƒ—ãƒªã‚»ãƒƒãƒˆã‚’ã€Œè‡ªç”±ã«æ“ä½œã™ã‚‹ã€ã«æˆ»ã™
            function resetPreset() {
                presetSelect.value = 'none';
            }

            // --- ä½ç½®ã®æ›´æ–°é–¢æ•° ---
            function updatePositions() {
                // è§’åº¦ã‚’ãƒ©ã‚¸ã‚¢ãƒ³ã«å¤‰æ›
                const mRad = moonAngleDeg * (Math.PI / 180);
                const sRad = sunAngleDeg * (Math.PI / 180);
                const incRad = inclinationDeg * (Math.PI / 180);

                // æœˆã®è»Œé“å¹³é¢ã‚’Zè»¸å‘¨ã‚Šã«å‚¾ã‘ã‚‹ï¼ˆæ­£ç¢ºãªç™½é“å‚¾æ–œè§’ã®è¡¨ç¾ï¼‰
                moonOrbitGroup.rotation.z = incRad;

                // æœˆã®ä½ç½®æ›´æ–° (å‚¾ãã‚’è€ƒæ…®)
                const baseX = Math.cos(mRad) * moonDistance;
                const baseZ = Math.sin(mRad) * moonDistance;
                
                // Zè»¸å‘¨ã‚Šã«å›è»¢ã•ã›ãŸåº§æ¨™ã‚’è¨ˆç®—
                moon.position.x = baseX * Math.cos(incRad);
                moon.position.y = baseX * Math.sin(incRad);
                moon.position.z = baseZ;

                // å¤ªé™½ã¨å¤ªé™½å…‰ã®ä½ç½®æ›´æ–°
                sun.position.x = Math.cos(sRad) * sunDistance;
                sun.position.z = Math.sin(sRad) * sunDistance;
                sunLight.position.copy(sun.position);

                // åœ°çƒã‚«ãƒ¡ãƒ©ã‚’æœˆã®æ–¹ã¸å‘ã‘ã‚‹
                earthCamera.lookAt(moon.position);

                // --- æ—¥é£Ÿãƒ»æœˆé£Ÿã®åˆ¤å®šã¨ãƒ†ã‚­ã‚¹ãƒˆæ›´æ–° ---
                // å¤ªé™½ã‚’åŸºæº–ã¨ã—ãŸæœˆã®ç›¸å¯¾è§’åº¦ (0ã€œ360) ã§åŸºæœ¬ã®æº€ã¡æ¬ ã‘ã‚’æ±ºå®š
                let relativeAngle = (moonAngleDeg - sunAngleDeg) % 360;
                if (relativeAngle < 0) relativeAngle += 360;

                let phase = "";
                if (relativeAngle < 10 || relativeAngle > 350) phase = "æ–°æœˆ (æœ”)";
                else if (relativeAngle >= 10 && relativeAngle < 80) phase = "ä¸‰æ—¥æœˆãƒ»æº€ã¡ã¦ã„ãæœˆ";
                else if (relativeAngle >= 80 && relativeAngle <= 100) phase = "ä¸Šå¼¦ã®æœˆ (åŠæœˆ)";
                else if (relativeAngle > 100 && relativeAngle < 170) phase = "åä¸‰å¤œãƒ»æº€ã¡ã¦ã„ãæœˆ";
                else if (relativeAngle >= 170 && relativeAngle <= 190) phase = "æº€æœˆ (æœ›)";
                else if (relativeAngle > 190 && relativeAngle < 260) phase = "åå…­å¤œãƒ»æ¬ ã‘ã¦ã„ãæœˆ";
                else if (relativeAngle >= 260 && relativeAngle <= 280) phase = "ä¸‹å¼¦ã®æœˆ (åŠæœˆ)";
                else phase = "äºŒåå…­å¤œãƒ»æ¬ ã‘ã¦ã„ãæœˆ";

                // é£Ÿã®å³å¯†ãªåˆ¤å®š (3Dç©ºé–“ã®ãƒ™ã‚¯ãƒˆãƒ«è§’åº¦å·®ã§è¨ˆç®—)
                const vecSun = new THREE.Vector3().copy(sun.position).normalize();
                const vecMoon = new THREE.Vector3().copy(moon.position).normalize();
                const angleDiffSun = vecSun.angleTo(vecMoon) * (180 / Math.PI); 
                
                const vecAntiSun = new THREE.Vector3().copy(sun.position).multiplyScalar(-1).normalize();
                const angleDiffAntiSun = vecAntiSun.angleTo(vecMoon) * (180 / Math.PI);

                let eclipseText = "";
                if (angleDiffSun < 1.0) {
                    eclipseText = "<br><span class='text-red-400'>çš†æ—¢/é‡‘ç’°æ—¥é£Ÿ ğŸŒ‘</span>";
                } else if (angleDiffSun < 5.7) {
                    eclipseText = "<br><span class='text-orange-400'>éƒ¨åˆ†æ—¥é£Ÿ ğŸŒ’</span>";
                } else if (angleDiffAntiSun < 6.0) {
                    eclipseText = "<br><span class='text-red-500 font-bold'>çš†æ—¢æœˆé£Ÿ ğŸ”´</span>";
                } else if (angleDiffAntiSun < 10.0) {
                    eclipseText = "<br><span class='text-orange-400'>éƒ¨åˆ†æœˆé£Ÿ ğŸŒ–</span>";
                }

                phaseNameDisplay.innerHTML = phase + eclipseText;

                // æœˆé£Ÿæ™‚ã®èµ¤éŠ…è‰²ã‚’è¡¨ç¾ (åœ°çƒã®å½±ã«å…¥ã£ãŸæ™‚ã®è‰²ã®å¤‰åŒ–ã‚’ãƒãƒ†ãƒªã‚¢ãƒ«ã§ç›´æ¥åˆ¶å¾¡)
                if (angleDiffAntiSun < 10.0) {
                    // é£Ÿã®æ·±ã•ã«å¿œã˜ã¦0.0(æµ…ã„)ã€œ1.0(æ·±ã„)ã®å€¤ã‚’è¨ˆç®—
                    const depth = Math.max(0, (10.0 - angleDiffAntiSun) / 10.0); 
                    
                    // è¡¨é¢ã®è‰²ã‚’æš—ãã—ã€èµ¤ã¿ã‚’æ®‹ã™
                    const r = 0.86 - (0.4 * depth);
                    const g = 0.86 - (0.8 * depth);
                    const b = 0.86 - (0.8 * depth);
                    moonMaterial.color.setRGB(r, g, b);
                    
                    // å½±ã®ä¸­ã§å®Œå…¨ã«çœŸã£æš—ã«ãªã‚‰ãªã„ã‚ˆã†ã€èµ¤éŠ…è‰²ã«ç™ºå…‰(emissive)ã•ã›ã‚‹
                    moonMaterial.emissive.setRGB(0.5 * depth, 0.05 * depth, 0.0);
                } else {
                    moonMaterial.color.setHex(0xdddddd); // é€šå¸¸ã®è‰²ã«æˆ»ã™
                    moonMaterial.emissive.setHex(0x000000); // ç™ºå…‰ã‚’ã‚ªãƒ•ã«ã™ã‚‹
                }

                // UIè¡¨ç¤ºã®æ›´æ–°
                moonDisplay.innerText = Math.floor(moonAngleDeg) + "Â°";
                sunDisplay.innerText = Math.floor(sunAngleDeg) + "Â°";
                inclinationDisplay.innerText = inclinationDeg.toFixed(1) + "Â°";
            }

            // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
            
            // ğŸ“… æ—¥ä»˜ã‹ã‚‰è¨ˆç®—ã—ã¦ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
            dateBtn.addEventListener('click', () => {
                const selectedDate = new Date(dateInput.value);
                if (isNaN(selectedDate.getTime())) return;

                // 1. å¤ªé™½ã®ä½ç½®ã‚’æ¦‚ç®— (1æœˆ1æ—¥ã‚’åŸºæº–ã«1å¹´ã§360åº¦å…¬è»¢ã™ã‚‹ã¨ä»®å®š)
                const startOfYear = new Date(selectedDate.getFullYear(), 0, 1);
                const oneDay = 1000 * 60 * 60 * 24;
                const diffDaysOfYear = (selectedDate - startOfYear) / oneDay;
                let calcSunAngle = (diffDaysOfYear / 365.2422) * 360;

                // 2. æœˆã®ä½ç½®ï¼ˆæº€ã¡æ¬ ã‘ï¼‰ã‚’æ¦‚ç®— (åŸºæº–ã¨ãªã‚‹æ–°æœˆã‹ã‚‰ã®çµŒéæ—¥æ•°ã§è¨ˆç®—)
                // åŸºæº–ã¨ãªã‚‹æ–°æœˆ: 2000å¹´1æœˆ6æ—¥ 18:14 UTC
                const refNewMoon = new Date(Date.UTC(2000, 0, 6, 18, 14, 0));
                const synodicMonth = 29.53058868; // æœ”æœ›æœˆ(æº€ã¡æ¬ ã‘ã®å‘¨æœŸ)
                const daysSinceRef = (selectedDate - refNewMoon) / oneDay;
                
                // å‘¨æœŸã‹ã‚‰ç¾åœ¨ã®ä½ç›¸(0.0ã€œ1.0)ã‚’è¨ˆç®—
                let phaseFraction = (daysSinceRef / synodicMonth) % 1;
                if (phaseFraction < 0) phaseFraction += 1; // 2000å¹´ä»¥å‰ã®å¯¾å¿œ
                
                // å¤ªé™½ã‚’åŸºæº–ã¨ã—ãŸæœˆã®ç›¸å¯¾è§’åº¦
                const relativeMoonAngle = phaseFraction * 360;

                // 3. ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã«åæ˜ 
                calcSunAngle = calcSunAngle % 360;
                let calcMoonAngle = (calcSunAngle + relativeMoonAngle) % 360;
                
                sunSlider.value = calcSunAngle;
                moonSlider.value = calcMoonAngle;
                inclinationSlider.value = 5.0; // æ—¥ä»˜æŒ‡å®šæ™‚ã¯å¹³å‡çš„ãªå‚¾ã(5åº¦)ã«ãƒªã‚»ãƒƒãƒˆ
                
                sunAngleDeg = calcSunAngle;
                moonAngleDeg = calcMoonAngle;
                inclinationDeg = 5.0;

                resetPreset();
                autoPlayCheck.checked = false;
                
                updatePositions();
            });
            
            // ãƒ—ãƒªã‚»ãƒƒãƒˆï¼ˆç¾è±¡ï¼‰ã®é¸æŠå‡¦ç†
            presetSelect.addEventListener('change', (e) => {
                const val = e.target.value;
                if (val === 'total-solar') {
                    moonSlider.value = 0;
                    sunSlider.value = 0;
                    inclinationSlider.value = 0;
                } else if (val === 'partial-solar') {
                    moonSlider.value = 0;
                    sunSlider.value = 0;
                    inclinationSlider.value = 2.5; // éƒ¨åˆ†æ—¥é£Ÿã«ãªã‚‹çµ¶å¦™ãªå‚¾ã
                } else if (val === 'total-lunar') {
                    moonSlider.value = 180;
                    sunSlider.value = 0;
                    inclinationSlider.value = 0;
                } else if (val === 'partial-lunar') {
                    moonSlider.value = 180;
                    sunSlider.value = 0;
                    inclinationSlider.value = 7.5; // éƒ¨åˆ†æœˆé£Ÿã«ãªã‚‹çµ¶å¦™ãªå‚¾ã
                }
                
                if (val !== 'none') {
                    autoPlayCheck.checked = false; // è‡ªå‹•å†ç”Ÿã‚’ã‚ªãƒ•ã«ã™ã‚‹
                    moonAngleDeg = parseFloat(moonSlider.value);
                    sunAngleDeg = parseFloat(sunSlider.value);
                    inclinationDeg = parseFloat(inclinationSlider.value);
                    updatePositions();
                }
            });

            moonSlider.addEventListener('input', (e) => {
                moonAngleDeg = parseFloat(e.target.value);
                resetPreset();
                updatePositions();
            });

            sunSlider.addEventListener('input', (e) => {
                sunAngleDeg = parseFloat(e.target.value);
                resetPreset();
                updatePositions();
            });

            inclinationSlider.addEventListener('input', (e) => {
                inclinationDeg = parseFloat(e.target.value);
                resetPreset();
                updatePositions();
            });

            // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ãƒªã‚µã‚¤ã‚ºå¯¾å¿œ
            window.addEventListener('resize', () => {
                mainCamera.aspect = window.innerWidth / window.innerHeight;
                mainCamera.updateProjectionMatrix();
                mainRenderer.setSize(window.innerWidth, window.innerHeight);

                // PiPã‚«ãƒ¡ãƒ©ã®ãƒªã‚µã‚¤ã‚º
                const newPipSize = pipCanvas.parentElement.clientWidth;
                pipRenderer.setSize(newPipSize, newPipSize);
            });

            // åˆæœŸä½ç½®ã®è¨­å®š
            updatePositions();

            // --- ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ— ---
            function animate() {
                requestAnimationFrame(animate);

                // è‡ªå‹•å†ç”Ÿãƒ­ã‚¸ãƒƒã‚¯
                if (autoPlayCheck.checked) {
                    moonAngleDeg = (moonAngleDeg + 0.5) % 360;
                    moonSlider.value = moonAngleDeg;
                    updatePositions();
                }

                controls.update();

                // ä¿¯ç°ãƒ“ãƒ¥ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                mainRenderer.render(scene, mainCamera);

                // åœ°çƒã‹ã‚‰ã®è¦–ç‚¹ï¼ˆPiPï¼‰ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                pipRenderer.render(scene, earthCamera);
            }

            animate();
            
            // åˆæœŸçŠ¶æ…‹ã¨ã—ã¦ä»Šæ—¥ã®æ—¥ä»˜ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã‚’å®Ÿè¡Œ
            dateBtn.click();
        };
    </script>
</body>
</html>
